<!DOCTYPE html>
<html>
<body>

  <h2>Create Commitments</h2>
  <button onclick="commit('0')">0</button><br>
  Secret: <input type="text", id="secret0", value="", style="width: 520px;font-family: monospace;", readonly><br>
  Hash: <input type="text", id="hash0", value="", style="width: 520px;font-family: monospace;", readonly><br>
  <br>
  <button onclick="commit('1')">1</button><br>
  Secret: <input type="text", id="secret1", value="", style="width: 520px;font-family: monospace;", readonly><br>
  Hash: <input type="text", id="hash1", value="", style="width: 520px;font-family: monospace;",  readonly><br>

  <hr>

  <h2>Open Commitments</h2>
  <input type="text", id="secret", value="Enter the secret", onfocus="this.value=''", style="width: 520px;font-family: monospace;"><br>
  <input type="text", id="hash", value="Enter the hash", onfocus="this.value=''", style="width: 520px;font-family: monospace;"><br>
  <button onclick="opencom()">Check</button>
  <p id="opening"><tt>Opening:</tt></p>
  <script>
    function dec2hex(dec) {
      var hex = dec.toString(16);
      if(hex.length < 2) {
        hex = '0' + hex;
      }
      return hex;
    }

    // https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/digest
    async function digestMessage(message) {
      const msgUint8 = new TextEncoder().encode(message);                           // encode as (utf-8) Uint8Array
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);           // hash the message
      const hashArray = Array.from(new Uint8Array(hashBuffer));                     // convert buffer to byte array
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); // convert bytes to hex string
      return hashHex;
    }
    
    async function commit(b) {
      var array = new Uint8Array(32);
      var R = "";
      window.crypto.getRandomValues(array);
      for (var i = 0; i < array.length; i++) {
        R = R+dec2hex(array[i]);
      }

      var H = await digestMessage(R.concat(b));
      document.getElementById("secret"+b.toString()).value = R;
      document.getElementById("hash"+b.toString()).value = H;
    }

    async function opencom() {
      var secret = document.getElementById("secret").value;
      var hash = document.getElementById("hash").value;
      hash0 = await digestMessage(secret+'0');
      if (hash0 == hash)
      {
        document.getElementById("opening").innerHTML = 'Opening: 0';
        return 0;
      }
      hash1 = await digestMessage(secret+'1'); 
      if (hash1 == hash)
      {
        document.getElementById("opening").innerHTML = 'Opening: 1';
        return 0;
      }
      
      document.getElementById("opening").innerHTML = 'Opening: Failed';
    }
  </script>
</body>
</html>
